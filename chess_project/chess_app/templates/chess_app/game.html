{% extends 'chess_app/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Left Section: Active Users -->
        <div class="col-md-6">
            <h2>Active Users</h2>
            <ul class="list-group" id="active-users-list">
                {% for profile in active_users %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ profile.user.username }} <!-- Display the username from the Profile model -->
                        <button class="btn btn-primary" onclick="inviteUser('{{ profile.user.username }}')">Invite</button>
                    </li>
                {% empty %}
                    <li class="list-group-item">No active users</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Right Section: Game History -->
        <div class="col-md-6">
            <h2>Game History</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Opponent</th>
                        <th>Result</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in match_history %}
                    <tr>
                        <td>{{ match.opponent.username }}</td>
                        <td>{{ match.result }}</td>
                        <td>{{ match.timestamp|date:"Y-m-d H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No matches played yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function getCSRFToken() {
        let cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
                return cookie.substring('csrftoken='.length, cookie.length);
            }
        }
        return '';
    }

    function inviteUser(username) {
        fetch("{% url 'send_invite' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ 'username': username })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Invite sent to ' + username);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error sending invite:', error);
        });
    }

    // Poll for invitations and active users every 1 second
    setInterval(checkInvitations, 1000);
    setInterval(checkActiveUsers, 1000);

    function checkInvitations() {
        fetch("{% url 'check_invites' %}")
        .then(response => response.json())
        .then(data => {
            console.log("Received data from server:", data);  // Debugging: Check what data is received
    
            if (data.invite) {
                let inviter = data.invite.inviter;
                if (confirm(inviter + " has invited you to play. Accept?")) {
                    handleInvitationResponse(inviter, 'accepted');
                } else {
                    handleInvitationResponse(inviter, 'rejected');
                }
            } else if (data.redirect && data.match_id) {
                console.log("Redirecting to game, match_id:", data.match_id);
                window.location.href = `/play_game/${data.match_id}/`;
            } else if (data.error) {
                console.error('Error:', data.error);  // Log any errors from the server
            }
        })
        .catch(error => {
            console.error('Error checking invitations:', error);
        });
    }
    
    
    
    
    

    function handleInvitationResponse(inviter, status) {
        fetch("{% url 'respond_invite' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ 'inviter': inviter, 'status': status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (status === 'accepted') {
                    window.location.href = `/play_game/${data.match_id}/`;
                } else {
                    alert('You declined the invite from ' + inviter);
                }
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error responding to invitation:', error);
        });
    }

    // Function to check for active users
    function checkActiveUsers() {
        fetch("{% url 'check_active_users' %}")
        .then(response => response.json())
        .then(data => {
            const activeUsersList = document.getElementById('active-users-list');
            activeUsersList.innerHTML = '';  // Clear the list

            if (data.active_users.length > 0) {
                data.active_users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        ${user.username}
                        <button class="btn btn-primary" onclick="inviteUser('${user.username}')">Invite</button>
                    `;
                    activeUsersList.appendChild(li);
                });
            } else {
                activeUsersList.innerHTML = '<li class="list-group-item">No active users</li>';
            }
        })
        .catch(error => {
            console.error('Error checking active users:', error);
        });
    }
</script>

{% endblock %}
